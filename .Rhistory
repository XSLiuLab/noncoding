saveRDS(final_dt, file = "final_mutation_regions.rds")
final_dt[, mut_index := paste(chr, as.integer(i.end), sep = ":")]
final_dt
saveRDS(final_dt, file = "final_mutation_regions.rds")
?poibin::ppoibin
point_prob = final_dt[, .(p_val = 1 - poibin::ppoibin(freq - 1, prob)),
by = mut_index]
point_prob
point_prob = final_dt[, .(p_val = 1 - poibin::ppoibin(freq - 1, prob)),
by = mut_index]
point_prob$mut_index
final_dt[, .(p_val = 1 - poibin::ppoibin(freq - 1, prob)),
by = mut_index]
final_dt[, .(p_val = 1 - poibin::ppoibin(freq - 1, prob)),
by = .(mut_index)]
length(table(final_dt$mut_index))
kk=0:10
pp=c(.1,.2,.3,.4,.5)
ppoibin(kk=kk, pp=pp, method = "DFT-CF",wts=rep(2,5))
library(poibin)
kk=0:10
pp=c(.1,.2,.3,.4,.5)
ppoibin(kk=kk, pp=pp, method = "DFT-CF",wts=rep(2,5))
summary(final_dt$freq)
final_dt
ppoibin(kk=kk, pp=pp)
kk
pp
ppoibin(kk=7, pp=pp)
ppoibin(kk=7, pp=pp[1])
## Get mutation-specific prob
final_dt[, .(p_val = 1 - poibin::ppoibin(freq - 1, prob)),
by = .(region_midpoint)]
load("D:/Code/noncoding/df2.RData")
df2
View(final_dt)
ppoibin(kk=7, pp=pp)
ppoibin(kk=0, pp=pp)
## Get mutation-specific prob
final_dt[, .(p_val = 1 - poibin::ppoibin(unique(freq) - 1, prob)),
by = .(region_midpoint)]
## Get mutation-specific prob
prob_mut <- final_dt[, .(p_val = 1 - poibin::ppoibin(unique(freq) - 1, prob)),
by = .(mut_index)]
prob_mut
length(unique(prob_mut$mut_index))
prob_mut
duplicated(prob_mut$mut_index)
prob_mut$mut_index[duplicated(prob_mut$mut_index)]
recurrent_region <- readRDS("D:/Code/noncoding/recurrent_region.rds")
View(recurrent_region)
nrow(unique(recurrent_region))
recurrent_region[, zz:=paste(chr, start, end, sep="-")]
length(unique(recurrent_region$zz))
final_dt
unique(final_dt)
head(final_dt)
library(data.table)
final_dt <- readRDS("final_mutation_regions.rds")
final_dt
## Add a weight to prob for each donor to get sample-specific prob as Prof.Liu and JingZhang devised.
#system("zcat final_mutation.tsv.gz | cut -f 1 | sort | uniq -c | sed 's/^[ \t]*//g' | sed 's/ /\t/g' > donor_noncoding_mut_freq.tsv")
donor_freq <- fread("donor_noncoding_mut_freq.tsv", header = FALSE)
View(donor_freq)
colnames(donor_freq) <- c("freq", "donor")
donor_freq[, weight := freq / sum(freq)]
donor_freq
final_dt
final_dt <- merge(final_dt, donor_freq, by = "donor", all.x = TRUE)
final_dt
final_dt[, prob := prob * weight]
any(is.na(final_dt$prob))
final_dt[, c("freq", "weight") := NULL]
final_dt
nrow(unique(final_dt))
## Get mutation-specific prob
## prob x >= K (K is the mutation freq, so here minus 1)
## ppoibin is used to get Pr(x<K)
prob_point <- final_dt[, .(p_val = 1 - poibin::ppoibin(length(donor) - 1, prob)),
by = .(mut_index)]
prob_point
.Machine$double.xmin
prob_point$p_val[1]
prob_point$p_val[1] < .Machine$double.xmin
.Machine
length(unique(final_dt$mut_index))
length(unique(final_dt$region_midpoint))
prob_mut$mut_index[duplicated(prob_mut$mut_index)]
prob_point$mut_index[duplicated(prob_point$mut_index)]
length(unique(final_dt$region_midpoint))
## Set 0 to minimal p value
prob_point[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_point
final_dt
## Get mutation-specific prob
## prob x >= K (K is the mutation freq, so here minus 1)
## ppoibin is used to get Pr(x<K)
prob_point <- final_dt[, .(p_val = 1 - poibin::ppoibin(length(donor) - 1, prob),
donor_list = paste(donor, collapse = ",")),
by = .(mut_index)]
prob_point
## Set 0 to minimal p value
prob_point[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
## Set 0 to minimal p value
prob_point[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_point
prob_point[order(p_val)]
prob_point = prob_point[order(p_val)]
openxlsx::write.xlsx(prob_point, file = "PointMutationList.xlsx")
final_dt
prob_point
## Get region prob
region_df <- merge(final_dt[, .(region_midpoint, mut_index)],
prob_point, by = "mut_index", all.x = TRUE)
region_df
prob_point
## Get region prob
region_df <- merge(final_dt[, .(region_midpoint, mut_index, donor)],
prob_point[, .(mut_index, p_val)],
by = "mut_index", all.x = TRUE)
region_df
p = c(0.1, 0.2, 0.3)
cumprod(p)
cal_region_p = function(p) {
1 - cumprod(1 - p)[length(p)]
}
cal_region_p(p)
prob_region <- region_df[, .(p_val = cal_region_p(p_val),
donor_list = paste(donor, collapse = ",")),
by = .(region_midpoint)]
prob_region
## Set 0 to minimal p value
prob_region[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_region = prob_region[order(p_val)]
prob_region
region_df
final_dt
z = final_dt[, .(donor, prob, mut_index)]
nrow(unique(z))
z = final_dt[, .(donor, mut_index)]
nrow(unique(z))
## Get mutation-specific prob
## prob x >= K (K is the mutation freq, so here minus 1)
## ppoibin is used to get Pr(x<K)
final_dt2 <- unique(final_dt[, .(donor, prob, mut_index)])
prob_point <- final_dt2[, .(p_val = 1 - poibin::ppoibin(length(donor) - 1, prob),
donor_list = paste(donor, collapse = ",")),
by = .(mut_index)]
prob_point
prob_point$mut_index[duplicated(prob_point$mut_index)]
## Set 0 to minimal p value
prob_point[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
length(unique(final_dt$mut_index))
length(unique(final_dt$region_midpoint))
prob_point = prob_point[order(p_val)]
prob_point
openxlsx::write.xlsx(prob_point, file = "PointMutationList.xlsx")
z = final_dt[, .(donor, region_midpoint, prob)]
nrow(unique(z))
z = final_dt[, .(donor, region_midpoint)]
nrow(unique(z))
z = final_dt[, .(donor, region_midpoint, donor)]
nrow(unique(z))
## Get region prob
region_df <- merge(unique(final_dt[, .(region_midpoint, mut_index, donor)]),
prob_point[, .(mut_index, p_val)],
by = "mut_index", all.x = TRUE)
nrow(unique(final_dt[, .(region_midpoint, mut_index, donor)])
)
final_dt
## Get region prob
region_df <- merge(unique(final_dt[, .(region_midpoint, mut_index, donor)]),
prob_point[, .(mut_index, p_val)],
by = "mut_index", all.x = TRUE)
region_df
cal_region_p = function(p) {
1 - cumprod(1 - p)[length(p)]
}
prob_region <- region_df[, .(p_val = cal_region_p(p_val),
donor_list = paste(donor, collapse = ",")),
by = .(region_midpoint)]
## Set 0 to minimal p value
prob_region[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_region = prob_region[order(p_val)]
prob_region
openxlsx::write.xlsx(prob_region, file = "RegionMutationList.xlsx")
region_df
prob_region <- region_df[, .(p_val = cal_region_p(p_val),
donor_list = paste(donor, collapse = ","),
mutation_list = paste(mut_index, collapse = ",")),
by = .(region_midpoint)]
prob_region
prob_region <- region_df[, .(p_val = cal_region_p(p_val),
donor_list = paste(donor, collapse = ","),
mutation_list = paste(unique(mut_index), collapse = ",")),
by = .(region_midpoint)]
## Set 0 to minimal p value
prob_region[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_region = prob_region[order(p_val)]
prob_region
openxlsx::write.xlsx(prob_region, file = "RegionMutationList.xlsx")
library(data.table)
final_dt <- readRDS("final_mutation_regions.rds")
## Add a weight to prob for each donor to get sample-specific prob as Prof.Liu and JingZhang devised.
#system("zcat final_mutation.tsv.gz | cut -f 1 | sort | uniq -c | sed 's/^[ \t]*//g' | sed 's/ /\t/g' > donor_noncoding_mut_freq.tsv")
donor_freq <- fread("donor_noncoding_mut_freq.tsv", header = FALSE)
colnames(donor_freq) <- c("freq", "donor")
donor_freq[, weight := freq / sum(freq)]
final_dt <- merge(final_dt, donor_freq, by = "donor", all.x = TRUE)
final_dt[, prob := prob * weight]
any(is.na(final_dt$prob))
final_dt[, c("freq", "weight") := NULL]
## Get mutation-specific prob
## prob x >= K (K is the mutation freq, so here minus 1)
## ppoibin is used to get Pr(x<K)
final_dt2 <- unique(final_dt[, .(donor, prob, mut_index)])
prob_point <- final_dt2[, .(p_val = 1 - poibin::ppoibin(length(donor) - 1, prob),
donor_list = paste(donor, collapse = ",")),
by = .(mut_index)]
prob_point
prob_point$mut_index[duplicated(prob_point$mut_index)]
## Set 0 to minimal p value
prob_point[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
length(unique(final_dt$mut_index))
length(unique(final_dt$region_midpoint))
prob_point = prob_point[order(p_val)]
## Get region prob
region_df <- merge(unique(final_dt[, .(region_midpoint, mut_index, donor)]),
prob_point[, .(mut_index, p_val)],
by = "mut_index", all.x = TRUE)
region_df
cal_region_p = function(p) {
1 - cumprod(1 - p)[length(p)]
}
prob_region <- region_df[, .(p_val = cal_region_p(p_val),
donor_list = paste(donor, collapse = ","),
mutation_list = paste(unique(mut_index), collapse = ",")),
by = .(region_midpoint)]
## Set 0 to minimal p value
prob_region[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_region = prob_region[order(p_val)]
prob_region
## Annotate records
# system(" cat ~/predict_prob/Homo_sapiens.GRCh37.75.gtf | grep gene | grep protein_coding > protein_coding_genes.tsv")
gene_dt <- fread("f:/zhangjing/protein_coding_genes.tsv", header = F)
head(gene_dt)
gene_dt <- gene_dt[V3 == "gene"]
extract_col <- function(x, name) {
library(magrittr)
stringr::str_extract(x, paste0(name, " ([^;]+);")) %>%
stringr::str_remove(paste0(name, " ")) %>%
stringr::str_remove_all("\"") %>%
stringr::str_remove(";")
}
gene_dt[, gene_name := extract_col(V9, "gene_name")]
gene_dt
"CDC20" %in% gene_dt$gene_name
"TERT" %in% gene_dt$gene_name
gene_df = gene_dt[, .(V1, V4, gene_name)]
gene_df
colnames(gene_df) = c("chr", "start", "gene_name")
save(gene_df, file = "gene_df.RData")
gene_df[, chr := paste0("chr",chr)]
gene_df
gene_df[, gene_start := start][, `:=`(start = gene_start - 5000, end = gene_start + 500)]
gene_df
prob_point
tidyr::separate(prob_point, col = "mut_index", into = c("chr", "start"), sep = ":")
prob_point = tidyr::separate(prob_point, col = "mut_index", into = c("chr", "start"), sep = ":")
prob_point
prob_point[, end := start]
prob_point
str(prob_point)
prob_point[, `:=`(start = as.integer(start), end = as.integer(end))]
str(gene_df)
setkey(gene_df, chr, start, end)
prob_point_final <- foverlaps(
prob_point,
gene_df,
type = "within"
)
prob_point_final
all(is.na(prob_point_final$gene_name))
sum(!is.na(prob_point_final$gene_name))
prob_point_final[!is.na(gene_name)]
prob_point_final[!is.na(gene_name)][, .(gene_name, i.start, p_value, donor_list)][order(p_value)]
prob_point_final[!is.na(gene_name)][, .(gene_name, i.start, p_val, donor_list)][order(p_val)]
prob_point_final = prob_point_final[!is.na(gene_name)][, .(gene_name, i.start, p_val, donor_list)][order(p_val)]
View(prob_point_final)
stringr::str_count("fds,fdsfg,sf,", ",")
prob_point_final$count = stringr::str_count(prob_point_final$donor_list, ",") + 1
openxlsx::write.xlsx(prob_point_final, file = "PointMutationList.xlsx")
prob_region
prob_region = tidyr::separate(prob_region, col = "region_midpoint", into = c("chr", "midpoint"), sep = ":")
prob_region
prob_region[, midpoint := as.integer(midpoint)][, start := midpoint - 5][, end := midpoint + 5]
prob_region
prob_region[, midpoint := as.integer(midpoint)][, start := midpoint - 5][, end := midpoint + 5]
prob_region
prob_region = as.data.table(prob_region)
prob_region[, midpoint := as.integer(midpoint)][, start := midpoint - 5][, end := midpoint + 5]
prob_region
prob_region_final <- foverlaps(
prob_region,
gene_df,
type = "within"
)
prob_region_final
, .(gene_name, chr, midpoint, p_val, donor_list)][
prob_region_final = prob_region_final[!is.na(gene_name)][
, .(gene_name, chr, midpoint, p_val, donor_list)][
order(p_val)]
prob_region_final
prob_region_final$count = stringr::str_count(prob_region_final$donor_list, ",") + 1
View(prob_region_final)
openxlsx::write.xlsx(prob_region_final, file = "RegionMutationList.xlsx")
final_dt <- readRDS("final_mutation_regions.rds")
View(final_dt)
library(data.table)
final_dt <- readRDS("final_mutation_regions.rds")
View(final_dt)
table(final_dt$mut_index)
table(final_dt$mut_index) %>% sort()
library(magrittr)
table(final_dt$mut_index) %>% sort()
table(final_dt$mut_index) %>% sort() %>% head()
table(final_dt$mut_index) %>% sort(decreasing = TRUE) %>% head()
## Annotate records
# system(" cat ~/predict_prob/Homo_sapiens.GRCh37.75.gtf | grep gene | grep protein_coding > protein_coding_genes.tsv")
gene_dt <- fread("/Volumes/pan/zhangjing/protein_coding_genes.tsv", header = F)
gene_dt <- gene_dt[V3 == "gene"]
extract_col <- function(x, name) {
library(magrittr)
stringr::str_extract(x, paste0(name, " ([^;]+);")) %>%
stringr::str_remove(paste0(name, " ")) %>%
stringr::str_remove_all("\"") %>%
stringr::str_remove(";")
}
gene_dt[, gene_name := extract_col(V9, "gene_name")]
View(gene_dt)
View(gene_dt)
gene_df = gene_dt[, .(V1, V4, V5, V7, gene_name)]
colnames(gene_df) = c("chr", "start", "end", "strand", "gene_name")
View(gene_df)
save(gene_df, file = "gene_df.RData")
library(data.table)
final_dt <- readRDS("final_mutation_regions.rds")
library(magrittr)
table(final_dt$mut_index) %>% sort(decreasing = TRUE) %>% head()
## Add a weight to prob for each donor to get sample-specific prob as Prof.Liu and JingZhang devised.
#system("zcat final_mutation.tsv.gz | cut -f 1 | sort | uniq -c | sed 's/^[ \t]*//g' | sed 's/ /\t/g' > donor_noncoding_mut_freq.tsv")
donor_freq <- fread("donor_noncoding_mut_freq.tsv", header = FALSE)
colnames(donor_freq) <- c("freq", "donor")
donor_freq[, weight := freq / sum(freq)]
final_dt <- merge(final_dt, donor_freq, by = "donor", all.x = TRUE)
final_dt[, prob := prob * weight]
any(is.na(final_dt$prob))
final_dt[, c("freq", "weight") := NULL]
View(gene_dt)
View(final_dt)
nrow(final_dt)
nrow(unique(final_dt))
final_dt
## Get mutation-specific prob
## prob x >= K (K is the mutation freq, so here minus 1)
## ppoibin is used to get Pr(x<K)
final_dt2 <- unique(final_dt[, .(donor, prob, mut_index)])
prob_point <- final_dt2[, .(p_val = 1 - poibin::ppoibin(length(donor) - 1, prob),
donor_list = paste(donor, collapse = ",")),
by = .(mut_index)]
prob_point
prob_point$mut_index[duplicated(prob_point$mut_index)]
## Set 0 to minimal p value
prob_point[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
length(unique(final_dt$mut_index))
length(unique(final_dt$region_midpoint))
prob_point = prob_point[order(p_val)]
prob_point
nrow(final_dt[, .(region_midpoint, mut_index, donor))
nrow(final_dt[, .(region_midpoint, mut_index, donor)])
## Get region prob
region_df <- merge(unique(final_dt[, .(region_midpoint, mut_index, donor)]),
prob_point[, .(mut_index, p_val)],
by = "mut_index", all.x = TRUE)
region_df
cal_region_p = function(p) {
1 - cumprod(1 - p)[length(p)]
}
prob_region <- region_df[, .(p_val = cal_region_p(p_val),
donor_list = paste(unique(donor), collapse = ","),
mutation_list = paste(unique(mut_index), collapse = ",")),
by = .(region_midpoint)]
prob_region
## Set 0 to minimal p value
prob_region[, p_val := ifelse(p_val < .Machine$double.xmin,
.Machine$double.xmin,
p_val)]
prob_region = prob_region[order(p_val)]
prob_region
gene_df
gene_df[, chr := paste0("chr", chr)]
gene_df
gene_df[, gene_start := start]
gene_df[, gene_end := end]
gene_df
gene_df[, `:=`(
start = ifelse(strand == "+", gene_start - 5000, gene_end + 5000),
end   = ifelse(strand == "+", gene_start - 1, gene_end + 1)
)]
gene_dt
gene_df
prob_point
prob_point = tidyr::separate(prob_point, col = "mut_index", into = c("chr", "start"), sep = ":")
prob_point
prob_point = as.data.table(prob_point)
prob_point[, end := start]
prob_point[, `:=`(start = as.integer(start), end = as.integer(end))]
setkey(gene_df, chr, start, end)
prob_point_final <- foverlaps(
prob_point,
gene_df,
type = "within"
)
gene_df
gene_df[, `:=`(
start = ifelse(strand == "+", gene_start - 5000, gene_end + 1),
end   = ifelse(strand == "+", gene_start - 1, gene_end + 5000)
)]
setkey(gene_df, chr, start, end)
prob_point_final <- foverlaps(
prob_point,
gene_df,
type = "within"
)
prob_point_final
prob_point_final = prob_point_final[!is.na(gene_name)][, .(gene_name, chr, i.start, p_val, donor_list)][order(p_val)]
prob_point_final
prob_point_final$count = stringr::str_count(prob_point_final$donor_list, ",") + 1
prob_point_final
View(prob_point_final)
prob_point_final[order(count, decreasing = TRUE)]
prob_point_final = prob_point_final[order(count, decreasing = TRUE)]
colnames(prob_point_final)[3] = "mut_position"
openxlsx::write.xlsx(prob_point_final, file = "PointMutationList.xlsx")
prob_region
prob_region = tidyr::separate(prob_region, col = "region_midpoint", into = c("chr", "midpoint"), sep = ":")
prob_region = as.data.table(prob_region)
prob_region
save(prob_point_final, file = "PointMutationList.RData")
prob_region[, midpoint := as.integer(midpoint)][, start := midpoint - 5][, end := midpoint + 5]
prob_region_final <- foverlaps(
prob_region,
gene_df,
type = "any"
)
prob_region_final
prob_region_final = prob_region_final[!is.na(gene_name)][
, .(gene_name, chr, midpoint, p_val, donor_list)][
order(p_val)]
prob_region_final$count = stringr::str_count(prob_region_final$donor_list, ",") + 1
prob_region_final = prob_region_final[order(count, decreasing = TRUE)]
View(prob_region_final)
View(prob_point_final)
save(prob_region_final, file = "RegionMutationList.RData")
openxlsx::write.xlsx(prob_region_final, file = "RegionMutationList.xlsx")
.libPaths()
install.packages("pacman")
install.packages("packrat")
pacman
pacman::p_up()
install.packages("‘WRS2’")
install.packages("WRS2")
pacman::p_up()
.libPaths()
install.packages("pacman")
install.packages("tidyverse")
install.packages("BiocManager")
BiocManager::install("sigminer")
install.packages("ezcox")
install.packages("UCSCXenaTools")
BiocManager::install("mikldk/roxytest")
BiocManager::install("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
remotes::install_github("mikldk/roxytest")
